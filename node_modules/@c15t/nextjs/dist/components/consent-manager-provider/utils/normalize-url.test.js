import{describe as t,expect as e,it as o}from"vitest";import{normalizeBackendURL as a,validateBackendURL as p}from"./normalize-url.js";t("validateBackendURL",()=>{o("should validate absolute URLs correctly",()=>{for(let t of["http://example.com","https://example.com","http://localhost:3000","https://api.example.com/path"]){let o=p(t);e(o.isAbsolute).toBe(!0),e(o.normalizedURL).toBe(t)}}),o("should trim trailing slashes from absolute URLs",()=>{for(let{input:t,expected:o}of[{input:"https://my-instance.c15t.dev/",expected:"https://my-instance.c15t.dev"},{input:"https://example.com/",expected:"https://example.com"},{input:"http://localhost:3000/",expected:"http://localhost:3000"},{input:"https://api.example.com/path/",expected:"https://api.example.com/path"}]){let a=p(t);e(a.isAbsolute).toBe(!0),e(a.normalizedURL).toBe(o)}}),o("should throw error for invalid absolute URLs",()=>{for(let t of["ftp://example.com","ws://example.com","not-a-url://","http:/invalid-url"])e(()=>p(t)).toThrow()}),o("should validate relative URLs correctly",()=>{for(let{input:t,expected:o}of[{input:"/api/c15t",expected:"/api/c15t"},{input:"/path/to/api",expected:"/path/to/api"}]){let a=p(t);e(a.isAbsolute).toBe(!1),e(a.normalizedURL).toBe(o)}}),o("should trim trailing slashes from relative URLs",()=>{for(let{input:t,expected:o}of[{input:"/api/c15t/",expected:"/api/c15t"},{input:"/path/to/api/",expected:"/path/to/api"},{input:"/",expected:"/"}]){let a=p(t);e(a.isAbsolute).toBe(!1),e(a.normalizedURL).toBe(o)}}),o("should throw error for invalid relative URLs",()=>{for(let t of["not-a-url","http://","https://","api/c15t"])e(()=>p(t)).toThrow()})}),t("normalizeBackendURL",()=>{let t=t=>({get:e=>t[e.toLowerCase()]||null});o("should return absolute URLs unchanged",()=>{let o="https://example.com/api";e(a(o,t({}))).toBe(o)}),o("should trim trailing slashes from absolute URLs",()=>{let o=t({});for(let{input:t,expected:p}of[{input:"https://my-instance.c15t.dev/",expected:"https://my-instance.c15t.dev"},{input:"https://example.com/api/",expected:"https://example.com/api"}])e(a(t,o)).toBe(p)}),o("should construct URL from x-forwarded headers",()=>{e(a("/api/c15t",t({"x-forwarded-proto":"https","x-forwarded-host":"example.com"}))).toBe("https://example.com/api/c15t")}),o("should construct URL from x-forwarded headers and trim trailing slashes",()=>{for(let{headers:o,input:p,expected:s}of[{headers:{"x-forwarded-proto":"https","x-forwarded-host":"my-instance.c15t.dev"},input:"/api/c15t/",expected:"https://my-instance.c15t.dev/api/c15t"},{headers:{"x-forwarded-proto":"https","x-forwarded-host":"example.com"},input:"/api/",expected:"https://example.com/api"}])e(a(p,t(o))).toBe(s)}),o("should use host header when x-forwarded-host is not available",()=>{e(a("/api/c15t",t({host:"example.com"}))).toBe("https://example.com/api/c15t")}),o("should use referer when host headers are not available",()=>{e(a("/api/c15t",t({referer:"https://example.com/some/path"}))).toBe("https://example.com/api/c15t")}),o("should use referer and trim trailing slashes",()=>{e(a("/api/c15t/",t({referer:"https://my-instance.c15t.dev/some/path"}))).toBe("https://my-instance.c15t.dev/api/c15t")}),o("should return null when no headers are available to determine base URL",()=>{e(a("/api/c15t",t({}))).toBeNull()}),o("should return null for invalid URLs",()=>{e(a("not-a-url://",t({host:"example.com"}))).toBeNull()})});