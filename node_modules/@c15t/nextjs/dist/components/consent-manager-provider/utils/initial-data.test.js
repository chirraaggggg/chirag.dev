import{afterEach as e,beforeEach as t,describe as o,expect as n,it as a,vi as r}from"vitest";import{extractRelevantHeaders as s}from"./headers.js";import{getC15TInitialData as i}from"./initial-data.js";import{normalizeBackendURL as l}from"./normalize-url.js";r.mock("next/headers",()=>({headers:()=>new Headers({"x-forwarded-proto":"https","x-forwarded-host":"example.com",cookie:"test=123"})})),r.mock("./headers",()=>({extractRelevantHeaders:r.fn()})),r.mock("./normalize-url",()=>({normalizeBackendURL:r.fn()})),o("getC15TInitialData",()=>{let o={"x-forwarded-proto":"https","x-forwarded-host":"example.com",cookie:"test=123"},c=new Headers({"x-forwarded-proto":"https","x-forwarded-host":"example.com",cookie:"test=123"}),d=r.fn();t(()=>{r.clearAllMocks(),r.stubGlobal("fetch",d),s.mockReturnValue(o),l.mockReturnValue("https://api.example.com")}),e(()=>{r.unstubAllGlobals()}),a("should return undefined when normalized URL is not available",async()=>{l.mockReturnValue(null),n(await i("https://example.com",c)).toBeUndefined()}),a("should return undefined when no relevant headers are present",async()=>{s.mockReturnValue({}),n(await i("https://example.com",c)).toBeUndefined()}),a("should successfully fetch and return consent banner data",async()=>{let e={showConsentBanner:!0,branding:"c15t",jurisdiction:{message:"Please accept cookies",code:"GDPR"},location:{countryCode:"US",regionCode:"CA"},translations:{language:"en",translations:{common:{acceptAll:"Accept All",rejectAll:"Reject All",customize:"Customize",save:"Save"},cookieBanner:{title:"Cookie Preferences",description:"We use cookies to improve your experience"},consentManagerDialog:{title:"Manage Cookie Preferences",description:"Customize your cookie preferences"},consentTypes:{necessary:{title:"Necessary",description:"Required for the website to function"},experience:{title:"Experience",description:"Enhance your browsing experience"},functionality:{title:"Functionality",description:"Enable specific functionality"},marketing:{title:"Marketing",description:"Help us improve our marketing"},measurement:{title:"Measurement",description:"Help us measure performance"}}}}};d.mockResolvedValueOnce({ok:!0,json:()=>Promise.resolve(e)});let t=await i("https://example.com",c);n(d).toHaveBeenCalledWith("https://api.example.com/show-consent-banner",{method:"GET",headers:o}),n(t).toEqual(e)}),a("should handle fetch failure gracefully",async()=>{d.mockRejectedValueOnce(Error("Network error")),n(await i("https://example.com",c)).toBeUndefined()}),a("should handle non-ok response gracefully",async()=>{d.mockResolvedValueOnce({ok:!1,status:500,statusText:"Internal Server Error"}),n(await i("https://example.com",c)).toBeUndefined()})});