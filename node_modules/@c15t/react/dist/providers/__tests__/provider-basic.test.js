import{jsx as e,jsxs as n}from"react/jsx-runtime";import{defaultTranslationConfig as t}from"c15t";import{afterEach as o,beforeEach as i,describe as a,expect as r,it as s,vi as l}from"vitest";import{render as c}from"vitest-browser-react";import{ConsentManagerProvider as d}from"../../index.js";let m=l.fn();window.fetch=m,a("ConsentManagerProvider Basic Request Behavior",()=>{i(()=>{l.resetAllMocks(),l.useFakeTimers(),m.mockResolvedValue(new Response(JSON.stringify({showConsentBanner:!0,jurisdiction:{code:"GDPR"},translations:{language:"en",translations:t.translations.en}}),{status:200,headers:{"Content-Type":"application/json"}}))}),o(()=>{l.clearAllMocks(),l.useRealTimers()}),s("should only make one initial request for consent banner status",async()=>{c(e(d,{options:{mode:"c15t",backendURL:"/api/c15t"},children:e("div",{children:"Test Component"})})),await l.runAllTimersAsync(),r(m).toHaveBeenCalledTimes(1),r(m).toHaveBeenCalledWith(r.stringContaining("/api/c15t/show-consent-banner"),r.any(Object))}),s("should not make additional requests when props change but core options remain same",async()=>{m.mockClear();let{rerender:n}=c(e(d,{options:{mode:"offline",react:{theme:{"banner.root":"light"}}},children:e("div",{children:"Light theme"})}));await l.runAllTimersAsync(),r(m).not.toHaveBeenCalled(),n(e(d,{options:{mode:"offline",react:{theme:{"banner.root":"dark"}}},children:e("div",{children:"Dark theme"})})),await l.runAllTimersAsync(),r(m).not.toHaveBeenCalled()}),s("should make a new request when core options change",async()=>{let{rerender:n}=c(e(d,{options:{mode:"c15t",backendURL:"/api/c15t-1"},children:e("div",{children:"First URL"})}));await l.runAllTimersAsync(),r(m).toHaveBeenCalledTimes(1),r(m).toHaveBeenCalledWith(r.stringContaining("/api/c15t-1/show-consent-banner"),r.any(Object)),m.mockClear(),n(e(d,{options:{mode:"c15t",backendURL:"/api/c15t-2"},children:e("div",{children:"Second URL"})})),await l.runAllTimersAsync(),r(m).toHaveBeenCalledWith(r.stringContaining("/api/c15t-2/show-consent-banner"),r.any(Object))}),s("should handle rapid re-renders without making duplicate requests",async()=>{m.mockClear();let{rerender:t}=c(e(d,{options:{mode:"offline"},children:e("div",{children:"Counter: 0"})}));await l.runAllTimersAsync(),r(m).not.toHaveBeenCalled();for(let o=1;o<=5;o++)t(e(d,{options:{mode:"offline"},children:n("div",{children:["Counter: ",o]})})),await l.runAllTimersAsync();r(m).not.toHaveBeenCalled()})});