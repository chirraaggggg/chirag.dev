import{jsx as e}from"react/jsx-runtime";import{afterEach as n,beforeEach as t,describe as r,expect as o,it as s,vi as i}from"vitest";import{render as d}from"vitest-browser-react";import{ConsentManagerProvider as a,clearConsentManagerCache as c}from"../consent-manager-provider.js";let l=({children:n})=>e("div",{"data-testid":"ssr-provider",children:n}),h=({label:n})=>e("div",{"data-testid":`render-${n}`,children:n});r("ConsentManagerProvider Hydration Behavior",()=>{t(()=>{i.resetAllMocks(),i.useFakeTimers(),c()}),n(()=>{i.clearAllMocks(),i.useRealTimers()}),s("should render children immediately without blocking during hydration",async()=>{let{getByTestId:n}=d(e(a,{options:{mode:"offline",consentCategories:["necessary","marketing"]},children:e(h,{label:"child"})}));o(n("render-child")).toBeInTheDocument(),o(n("render-child")).toHaveTextContent("child"),await i.runAllTimersAsync(),o(n("render-child")).toBeInTheDocument()}),s("should not block SSR provider content when ConsentManager wraps SSR provider",async()=>{let{getByTestId:n}=d(e(a,{options:{mode:"offline",consentCategories:["necessary","marketing"]},children:e(l,{children:e(h,{label:"ssr-content"})})}));o(n("ssr-provider")).toBeInTheDocument(),o(n("render-ssr-content")).toBeInTheDocument(),o(n("render-ssr-content")).toHaveTextContent("ssr-content"),await i.runAllTimersAsync(),o(n("ssr-provider")).toBeInTheDocument(),o(n("render-ssr-content")).toBeInTheDocument()}),s("should not block SSR provider content when SSR provider wraps ConsentManager",async()=>{let{getByTestId:n}=d(e(l,{children:e(a,{options:{mode:"offline",consentCategories:["necessary","marketing"]},children:e(h,{label:"nested-content"})})}));o(n("ssr-provider")).toBeInTheDocument(),o(n("render-nested-content")).toBeInTheDocument(),o(n("render-nested-content")).toHaveTextContent("nested-content"),await i.runAllTimersAsync(),o(n("ssr-provider")).toBeInTheDocument(),o(n("render-nested-content")).toBeInTheDocument()}),s("should handle rapid re-renders without blocking children",async()=>{let{rerender:n,getByTestId:t}=d(e(a,{options:{mode:"offline",consentCategories:["necessary"]},children:e(h,{label:"rapid-render"})}));o(t("render-rapid-render")).toBeInTheDocument();for(let r=0;r<3;r++)n(e(a,{options:{mode:"offline",consentCategories:["necessary","marketing"]},children:e(h,{label:"rapid-render"})})),o(t("render-rapid-render")).toBeInTheDocument(),await i.runAllTimersAsync()}),s("should use startTransition for non-blocking state updates during hydration",async()=>{let n=!1,{getByTestId:t}=d(e(a,{options:{mode:"offline",consentCategories:["necessary"]},children:e(()=>(n=!0,e("div",{"data-testid":"hydration-test",children:"Content"})),{})}));o(n).toBe(!0),o(t("hydration-test")).toBeInTheDocument(),await i.runAllTimersAsync(),o(t("hydration-test")).toBeInTheDocument()})});