import { err, errAsync } from "neverthrow";
import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
import { createLogger } from "../../core/logger.js";
import { logResult, logResultAsync } from "../../utils/result.js";
describe('logger integration', ()=>{
    beforeEach(()=>{
        vi.spyOn(console, 'log').mockImplementation(()=>{});
        vi.spyOn(console, 'warn').mockImplementation(()=>{});
        vi.spyOn(console, 'error').mockImplementation(()=>{});
        vi.spyOn(console, 'debug').mockImplementation(()=>{});
    });
    afterEach(()=>{
        vi.restoreAllMocks();
    });
    describe('full logger pipeline', ()=>{
        it('should work with default logger and result logging together', ()=>{
            const logger = createLogger();
            const testError = {
                message: 'Integration test error',
                code: 'INTEGRATION_TEST'
            };
            const errorResult = err(testError);
            logResult(errorResult, logger);
            expect(console.error).toHaveBeenCalledTimes(1);
            const mockedConsoleError = vi.mocked(console.error);
            expect(mockedConsoleError.mock.calls[0]?.[0]).toContain('ERROR');
            expect(mockedConsoleError.mock.calls[0]?.[0]).toContain('Integration test error');
            expect(mockedConsoleError.mock.calls[0]?.[1]).toEqual(testError);
        });
        it('should work with custom log level and error logging together', ()=>{
            const logger = createLogger({
                level: 'info'
            });
            logger.info('Info message');
            logger.debug('Debug message');
            logger.warn('Warning message');
            expect(console.log).toHaveBeenCalledTimes(1);
            expect(console.debug).toHaveBeenCalledTimes(0);
            expect(console.warn).toHaveBeenCalledTimes(1);
            const testError = {
                message: 'Integration error'
            };
            logResult(err(testError), logger);
            expect(console.error).toHaveBeenCalledTimes(1);
        });
        it('should work with custom log handler and result logging', ()=>{
            const customLogHandler = vi.fn();
            const logger = createLogger({
                level: 'info',
                log: customLogHandler,
                appName: 'c15t'
            });
            logger.info('Direct info');
            logger.error('Direct error');
            expect(customLogHandler).toHaveBeenCalledTimes(2);
            const testError = {
                message: 'Result error'
            };
            logResult(err(testError), logger);
            expect(customLogHandler).toHaveBeenCalledTimes(3);
            const mockedCustomLogHandler = vi.mocked(customLogHandler);
            expect(mockedCustomLogHandler.mock.calls[2]?.[0]).toBe('error');
            expect(mockedCustomLogHandler.mock.calls[2]?.[1]).toBe('Error: Result error');
        });
        it('should support async result logging with the logger', async ()=>{
            const logger = createLogger();
            const testError = {
                message: 'Async integration error'
            };
            const errorResultAsync = errAsync(testError);
            await logResultAsync(errorResultAsync, logger).match(()=>{}, ()=>{});
            expect(console.error).toHaveBeenCalledTimes(1);
            const mockedConsoleError = vi.mocked(console.error);
            expect(mockedConsoleError.mock.calls[0]?.[0]).toContain('Async integration error');
        });
        it('should use custom application name in logs', ()=>{
            const customAppName = 'c15t-api';
            const logger = createLogger({
                level: 'info',
                appName: customAppName
            });
            logger.info('Application started');
            logger.warn('Configuration incomplete');
            logger.error('Failed to connect to database');
            const mockedConsoleLog = vi.mocked(console.log);
            const mockedConsoleWarn = vi.mocked(console.warn);
            const mockedConsoleError = vi.mocked(console.error);
            expect(mockedConsoleLog.mock.calls[0]?.[0]).toContain(`[${customAppName}]`);
            expect(mockedConsoleWarn.mock.calls[0]?.[0]).toContain(`[${customAppName}]`);
            expect(mockedConsoleError.mock.calls[0]?.[0]).toContain(`[${customAppName}]`);
            expect(mockedConsoleLog.mock.calls[0]?.[0]).not.toContain('[c15t]');
            const testError = {
                message: 'Integration error with custom app name'
            };
            logResult(err(testError), logger);
            expect(mockedConsoleError.mock.calls[1]?.[0]).toContain(`[${customAppName}]`);
            expect(mockedConsoleError.mock.calls[1]?.[0]).toContain('Integration error with custom app name');
        });
    });
});
